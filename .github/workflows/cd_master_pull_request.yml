name: CD For Processing a Pull Request to Master

on:
  pull_request:
    branches:
      - master

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      - name: Locally checkout master
        run: git checkout master
      - name: Fetch branches
        run: git fetch
      - name: Test merge locally
        run: git merge ${GITHUB_HEAD_REF}
        if: success()
      - name: Test build on local merged master
        run: make build
        if: success()
      - name: Create tag for this release
        run: git tag -a ${GITHUB_HEAD_REF} -m "Create tag for ${GITHUB_SHA}"
        if: success()
      - name: Push merged pull request to Origin/Master with tag and delete working branch
        run: git push origin --tags --delete ${GITHUB_HEAD_REF}
        if: success()
